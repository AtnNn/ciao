:- module(wsetup,[main/0],[assertions,isomodes]).

:- comment(title,"Setup Script for CIAO Installation under Windows").

:- comment(author,"Daniel Cabeza").

:- use_module(library(lists), [append/3,list_concat/2]).
:- use_module(library(streams), [open_output/2, close_output/1]).
:- use_module(library(system), [getenvstr/2, working_directory/2]).
:- use_module(registry).

:- include(library('compiler/win_exec_ext')).

main :-
        working_directory(Dir,Dir),
        make_header(Dir),
        atom_codes(Dir,DirStr),
        cyg2win(DirStr,CiaoPath),
        list_concat(["""",CiaoPath,"\\Win32\\bin\\ciaoengine.exe"""],Engine),
        make_bats(Engine),
        exec_ext(ExeExt),
        ciaoreg(CiaoPath, Engine, ExeExt, Registry),
        win_reg(Registry, String, []),
        open_output('ciao.reg',Out),
        display_string(String),
        close_output(Out).

make_header(CiaoPath) :-
        open_output('$/lib/compiler/header', Out),
        display('#!/bin/sh\n'),
        display('INSTENGINE="'),
        display(CiaoPath),
        display('/Win32/bin/ciaoengine.exe"\n'),
        display('ENGINE=${CIAOENGINE:-${INSTENGINE}}\n'),
        display('exec "$ENGINE" "$@" -C -b $0\n\^L\n'),
        close_output(Out).

make_bats(Engine) :-
        ( getenvstr('OS',"Windows_NT") ->
            AllArgs = ' %*' 
        ; AllArgs = ' %1 %2 %3 %4 %5 %6 %7 %8 %9'
        ),
        bat_file(BatFile, Head, Tail),
          open_output(BatFile, Out),
          display(Head),
          display_string("@"||Engine),
          display(AllArgs),
          display(Tail),
          close_output(Out),
        fail.
make_bats(_).

bat_file('Win32/bat_skel',
         '@REM Change /path/to/ciao/application to the absolute path \c
          of the application\n',
         ' -C -b "/path/to/ciao/application"').
bat_file('shell/ciaosh.bat','',' -C -i -b "$/shell/ciaosh"').
bat_file('ciaoc/ciaoc.bat','',' -C -b "$/ciaoc/ciaoc"').

:- pred ciaoreg(+string, +string, +atm, -string).

ciaoreg(CiaoPath, Engine, ExeExt, Reg) :-
        append(CiaoPath, "\\Win32\\ciaoexe.ico,0", ExeIco),
        append(CiaoPath, "\\Win32\\ciaoitf.ico,0", ItfIco),
        append(CiaoPath, "\\Win32\\ciaopo.ico,0", PoIco),
        append(CiaoPath, "\\Win32\\ciaoasr.ico,0", AsrIco),
        append(CiaoPath, "\\Win32\\ciaopl.ico,0", PlIco),
        append(CiaoPath, "\\Win32\\ciaoscrt.ico,0", ScrtIco),
        append(Engine, " %2 %3 %4 %5 %6 %7 %8 %9 -C -b ""%1""",
               ExeCommand),
        append(Engine," ""%1"" -C -b $\\ciaoc\\ciaoc", MakeExecCmd),
        append(Engine,
               " ""%1"" %2 %3 %4 %5 %6 %7 %8 %9 -C -b $\\shell\\ciao-shell",
               ExeScrtCmd),
        ROOT = 'HKEY_CLASSES_ROOT',
        Reg = [
        % .cpx files
        [[ROOT,ExeExt],
          '@'="ciaoexefile"],
        [[ROOT,ciaoexefile],
          '@'="Ciao executable"%,
         % 'EditFlags'=0x00000000
        ],
        [[ROOT,ciaoexefile,'DefaultIcon'],
          '@'=ExeIco],
        [[ROOT,ciaoexefile,shell],
          '@'=""],
        [[ROOT,ciaoexefile,shell,open],
          'EditFlags'=0x01000000],
        [[ROOT,ciaoexefile,shell,open,command],
          '@'=ExeCommand],
        % .pl files
        [[ROOT,'.pl'],
          '@'="ciaofile"],
        [[ROOT,ciaofile],
          '@'="Ciao Prolog source",
          'EditFlags'=0x00000000],
        [[ROOT,ciaofile,'DefaultIcon'],
          '@'=PlIco],
        [[ROOT,ciaofile,shell],
          '@'=""],
        [[ROOT,ciaofile,shell,open],
          'EditFlags'=0x01000000],
        [[ROOT,ciaofile,shell,open,command],
          '@'=""],
        [[ROOT,ciaofile,shell,make_executable],
          '@'="Make executable"],
        [[ROOT,ciaofile,shell,make_executable,command],
          '@'=MakeExecCmd],
        % .pls files
        [[ROOT,'.pls'],
          '@'="ciaoplsfile"],
        [[ROOT,ciaoplsfile],
          '@'="Ciao Prolog script",
          'EditFlags'=0x00000000],
        [[ROOT,ciaoplsfile,'DefaultIcon'],
          '@'=ScrtIco],
        [[ROOT,ciaoplsfile,shell],
          '@'=""],
        [[ROOT,ciaoplsfile,shell,open],
          'EditFlags'=0x01000000],
        [[ROOT,ciaoplsfile,shell,open,command],
          '@'=ExeScrtCmd],
        % .itf files
        [[ROOT,'.itf'],
          '@'="ciaoitffile"],
        [[ROOT,ciaoitffile],
          '@'="Ciao interface file",
          'EditFlags'=0x00000000],
        [[ROOT,ciaoitffile,'DefaultIcon'],
          '@'=ItfIco],
        [[ROOT,ciaoitffile,shell],
          '@'=""],
        % .po files
        [[ROOT,'.po'],
          '@'="ciaopofile"],
        [[ROOT,ciaopofile],
          '@'="Ciao object file",
          'EditFlags'=0x00000000],
        [[ROOT,ciaopofile,'DefaultIcon'],
          '@'=PoIco],
        [[ROOT,ciaopofile,shell],
          '@'=""],
        % .asr files
        [[ROOT,'.asr'],
          '@'="ciaoasrfile"],
        [[ROOT,ciaoasrfile],
          '@'="Ciao assertions file",
          'EditFlags'=0x00000000],
        [[ROOT,ciaoasrfile,'DefaultIcon'],
          '@'=AsrIco],
        [[ROOT,ciaoasrfile,shell],
          '@'=""]].
        

cyg2win("//"||[D,0'/ | Dir], [D,0':,0'\\ | Path]) :- !, % Drive letter
        swapslash(Dir,Path).
cyg2win("//"||Dir, "\\\\"||Path) :- !,                  % Network drive
        swapslash(Dir,Path).
cyg2win(Dir,  [D,0': |Path]) :-                         % Default drive
        swapslash(Dir,Path),
        default_drive(D).

default_drive(D) :-
        getenvstr('COMSPEC',[D|_]), !. % Shell command interpreter' drive
default_drive(0'C).                    % If not defined, suppose C


swapslash([],[]).
swapslash([0'/|D],[0'\\|ND]) :- !,
        swapslash(D,ND).
swapslash([C|D],[C|ND]) :-
        swapslash(D,ND).

